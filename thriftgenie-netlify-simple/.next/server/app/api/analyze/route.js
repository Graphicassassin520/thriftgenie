"use strict";(()=>{var e={};e.id=652,e.ids=[652],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7441:e=>{e.exports=require("sharp")},6497:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>I,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{POST:()=>d,dynamic:()=>c});var n=r(9303),a=r(8716),i=r(670),o=r(7070),p=r(2040),l=r(298),u=r(2663);let c="force-dynamic";async function d(e){let t=Date.now();try{let r=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown";if(!(0,l.Dn)(r,10,6e4))return(0,l.y8)("analyze",!1),o.NextResponse.json({error:"Rate limit exceeded. Please try again in a minute.",ai_system:"none",powered_by:"Rate Limiter"},{status:429});let s=await e.json(),n=(0,l.Eg)(s);if(!n)return(0,l.y8)("analyze",!1),o.NextResponse.json({error:"Invalid input. Please provide a valid imageUrl and platforms array.",ai_system:"none",powered_by:"Input Validator"},{status:400});let{imageUrl:a,platforms:i}=n;console.log("\uD83D\uDE80 Starting OpenAI-powered analysis for:",a),console.log("\uD83D\uDCF8 Step 1: Analyzing image with OpenAI Vision...");let c=await (0,p.RA)(a);console.log("\uD83D\uDCB0 Step 2: Generating pricing with OpenAI...");let d=await (0,p.iL)(c);console.log("\uD83D\uDCDD Step 3: Generating platform content with OpenAI...");let m=await (0,p.UI)(c,d,i);console.log("\uD83D\uDCBE Step 4: Saving to database...");let g=await u._.listing.create({data:{originalImageUrl:a,category:c.category,condition:c.condition,material:c.material,color:c.color,brand:c.brand,dimensions:c.dimensions,suggestedPrice:d.suggested_price_usd,pricingReason:d.pricing_reasoning,platformContent:{create:m.map(e=>({platform:e.platform,title:e.title,description:e.description,hashtags:e.hashtags}))}},include:{platformContent:!0}}),y=Date.now()-t;return(0,l.y8)("analyze",!0),console.log("✅ Analysis completed successfully with OpenAI"),o.NextResponse.json({success:!0,ai_system:"OpenAI",powered_by:"OpenAI GPT-4o-mini Vision API",data:{id:g.id,analysis:c,pricing:d,platformContent:m,createdAt:g.createdAt,processingTimeMs:y}})}catch(r){let e=Date.now()-t;if((0,l.y8)("analyze",!1),console.error("❌ Analysis error:",r),r?.status===400&&r?.message?.includes("download"))return o.NextResponse.json({error:"OpenAI cannot access the image URL. Please ensure the image is publicly accessible or try uploading a different image.",ai_system:"OpenAI",powered_by:"OpenAI GPT-4o-mini Vision API",error_type:"image_access_error",processingTimeMs:e},{status:400});if(r?.status===401)return o.NextResponse.json({error:"OpenAI API authentication failed. Please contact support.",ai_system:"OpenAI",powered_by:"OpenAI GPT-4o-mini Vision API",error_type:"auth_error",processingTimeMs:e},{status:500});if(r?.status===429)return o.NextResponse.json({error:"OpenAI API rate limit exceeded. Please try again in a few moments.",ai_system:"OpenAI",powered_by:"OpenAI GPT-4o-mini Vision API",error_type:"rate_limit_error",processingTimeMs:e},{status:429});if(r?.message?.includes("OpenAI API key"))return o.NextResponse.json({error:"OpenAI service is not properly configured. Please contact support.",ai_system:"OpenAI",powered_by:"OpenAI GPT-4o-mini Vision API",error_type:"config_error",processingTimeMs:e},{status:500});if(r?.name==="OpenAIError"||r?.status)return(0,l.eg)(r);if(r?.code==="P2002")return o.NextResponse.json({error:"Duplicate listing detected",ai_system:"Database",powered_by:"Prisma ORM",error_type:"duplicate_error",processingTimeMs:e},{status:409});return o.NextResponse.json({error:"Failed to analyze image using OpenAI. Please try again or contact support if the problem persists.",ai_system:"OpenAI",powered_by:"OpenAI GPT-4o-mini Vision API",error_type:"service_error",processingTimeMs:e},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/analyze/route",pathname:"/api/analyze",filename:"route",bundlePath:"app/api/analyze/route"},resolvedPagePath:"/Users/johnstuart/Downloads/AI_Image_Analysis_for_Products/listing-optimizer/app/app/api/analyze/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:f}=m,A="/api/analyze/route";function I(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},2663:(e,t,r)=>{r.d(t,{_:()=>n});let s=require("@prisma/client"),n=globalThis.prisma??new s.PrismaClient},298:(e,t,r)=>{r.d(t,{Dn:()=>a,Eg:()=>p,Sq:()=>o,eg:()=>i,y8:()=>l});var s=r(7070);let n=new Map;function a(e,t=10,r=6e4){let s=Date.now(),a=n.get(e);return!a||s>a.resetTime?(n.set(e,{count:1,resetTime:s+r}),!0):!(a.count>=t)&&(a.count++,!0)}function i(e){return(console.error("OpenAI API Error:",e),e?.status===429)?s.NextResponse.json({error:"Rate limit exceeded. Please try again later.",type:"rate_limit"},{status:429}):e?.status===401?s.NextResponse.json({error:"API authentication failed.",type:"auth_error"},{status:500}):e?.status===400?s.NextResponse.json({error:"Invalid request to AI service.",type:"bad_request"},{status:400}):s.NextResponse.json({error:"AI service temporarily unavailable. Please try again.",type:"service_error"},{status:503})}function o(e){try{let t=new URL(e);if(!["http:","https:","data:"].includes(t.protocol))return!1;if("data:"===t.protocol)return e.startsWith("data:image/");let r=t.pathname.toLowerCase(),s=t.hostname.toLowerCase();if(["images.unsplash.com","unsplash.com","imgur.com","i.imgur.com","cdn.","images."].some(e=>s.includes(e))||[".jpg",".jpeg",".png",".gif",".webp",".heic"].some(e=>r.includes(e))||e.includes("format=")||e.includes("auto=format")||e.includes("w=")||e.includes("h="))return!0;return!1}catch{return!1}}function p(e){if(!e||"object"!=typeof e)return null;let{imageUrl:t,platforms:r}=e;if(!t||"string"!=typeof t||!o(t)||!r||!Array.isArray(r)||0===r.length)return null;let s=["facebook","instagram","tiktok","poshmark","mercari","craigslist","etsy","website","x"],n=r.filter(e=>"string"==typeof e&&s.includes(e));return 0===n.length?null:{imageUrl:t.trim(),platforms:n}}function l(e,t,r){let s=new Date().toISOString();console.log(`[USAGE] ${s} - ${e}: ${t?"SUCCESS":"FAILED"}${r?` (${r} tokens)`:""}`)}setInterval(function(){let e=Date.now();for(let[t,r]of n.entries())e>r.resetTime&&n.delete(t)},3e5)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,972,991,40],()=>r(6497));module.exports=s})();